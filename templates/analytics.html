{% extends "base.html" %}

{% block title %}Analytics - NetViz{% endblock %}

{% block content %}
<hgroup>
  <h1>Analytics</h1>
  <p>Correlations and metrics</p>
</hgroup>

<!-- Stats Grid -->
<div class="grid-stats">
  <article class="stat-card">
    <div class="stat-value" id="totalNetworks">-</div>
    <div class="stat-label">Total Networks</div>
  </article>

  <article class="stat-card">
    <div class="stat-value" id="avgIxCount">-</div>
    <div class="stat-label">Avg IX Count</div>
  </article>

  <article class="stat-card">
    <div class="stat-value" id="correlationValue">-</div>
    <div class="stat-label">Correlation (IX/Fac)</div>
  </article>
</div>

<!-- Scatter Plot -->
<article>
  <header>IX Count vs Facility Count</header>
  <div class="chart-container">
     <div id="loadingSpinner" aria-busy="true">Loading data...</div>
     <canvas id="correlationChart" style="display: none;"></canvas>
     <div id="errorState" style="display: none;">
         <p>Failed to load data</p>
         <button class="outline" onclick="loadChartData()">Retry</button>
     </div>
  </div>
</article>
{% endblock %}

{% block scripts %}
<script>
  let chart = null;
  const chartConfig = {
      type: 'scatter',
      data: {
          datasets: [{
              label: 'Networks',
              data: [],
              backgroundColor: 'rgba(59, 130, 246, 0.6)',
              borderColor: '#3b82f6',
              borderWidth: 1,
              pointRadius: 4,
              pointHoverRadius: 6
          }]
      },
      options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
              x: {
                  title: { display: true, text: 'IX Count' }
              },
              y: {
                  title: { display: true, text: 'Facility Count' }
              }
          },
          plugins: {
              tooltip: {
                  callbacks: {
                      title: (ctx) => ctx[0].raw.label || 'Network',
                      label: (ctx) => `IX: ${ctx.raw.x}, Fac: ${ctx.raw.y}`
                  }
              }
          }
      }
  };

  async function loadChartData() {
      const spinner = document.getElementById("loadingSpinner");
      const canvas = document.getElementById("correlationChart");
      const error = document.getElementById("errorState");

      spinner.style.display = "block";
      canvas.style.display = "none";
      error.style.display = "none";

      try {
          const res = await fetch("/api/ix-facility-correlation");
          if (!res.ok) throw new Error("API Error");
          const data = await res.json();

          updateStats(data);

          spinner.style.display = "none";
          canvas.style.display = "block";
          
          const ctx = canvas.getContext("2d");
          if (chart) chart.destroy();
          
          chartConfig.data.datasets[0].data = data;
          chart = new Chart(ctx, chartConfig);
      } catch (err) {
          console.error(err);
          spinner.style.display = "none";
          error.style.display = "block";
      }
  }

  function updateStats(data) {
      if (!data.length) return;
      
      const total = data.length;
      document.getElementById("totalNetworks").innerText = total.toLocaleString();
      
      const avgIx = data.reduce((s, p) => s + p.x, 0) / total;
      document.getElementById("avgIxCount").innerText = avgIx.toFixed(1);

      // Simple correlation
      if (total > 1) {
          const sumX = data.reduce((s, p) => s + p.x, 0);
          const sumY = data.reduce((s, p) => s + p.y, 0);
          const sumXY = data.reduce((s, p) => s + p.x * p.y, 0);
          const sumX2 = data.reduce((s, p) => s + p.x * p.x, 0);
          const sumY2 = data.reduce((s, p) => s + p.y * p.y, 0);
          
          const num = total * sumXY - sumX * sumY;
          const den = Math.sqrt((total * sumX2 - sumX*sumX) * (total * sumY2 - sumY*sumY));
          const r = den === 0 ? 0 : num / den;
          document.getElementById("correlationValue").innerText = r.toFixed(3);
      }
  }

  document.addEventListener("DOMContentLoaded", loadChartData);
</script>
{% endblock %}
