{% extends "base.html" %}

{% block title %}Dashboard - NetViz{% endblock %}

{% block content %}
<hgroup>
  <h1>Dashboard</h1>
  <p>Network statistics and insights</p>
</hgroup>

<!-- Stats Grid -->
<div class="grid-stats">
  <article class="stat-card">
    <div class="stat-value">{{ stats.total_networks }}</div>
    <div class="stat-label">Total Networks</div>
  </article>
  
  <article class="stat-card">
    <div class="stat-value">{{ stats.network_types | length }}</div>
    <div class="stat-label">Network Types</div>
  </article>

  <article class="stat-card">
    <div class="stat-value">{{ stats.policy_types | length }}</div>
    <div class="stat-label">Policy Types</div>
  </article>

  <article class="stat-card">
    <div class="stat-value">{{ stats.scopes["Global"] | default(value=0) }}</div>
    <div class="stat-label">Global Scope</div>
  </article>
</div>

<!-- Charts Grid -->
<div class="grid">
  <article>
    <header>Network Types Distribution</header>
    <div class="chart-container">
      <div id="networkTypesLoading" aria-busy="true">Loading...</div>
      <canvas id="networkTypesChart" style="display: none;"></canvas>
      <div id="networkTypesError" style="display: none;">
        <p class="headings">Failed to load data</p>
        <button class="outline" onclick="loadNetworkTypesChart()">Retry</button>
      </div>
    </div>
  </article>

  <article>
    <header>IPv4 vs IPv6 Prefixes (Top 15)</header>
    <div class="chart-container">
      <div id="prefixesLoading" aria-busy="true">Loading...</div>
      <canvas id="prefixesChart" style="display: none;"></canvas>
      <div id="prefixesError" style="display: none;">
        <p>Failed to load data</p>
        <button class="outline" onclick="loadPrefixesChart()">Retry</button>
      </div>
    </div>
  </article>
</div>

<!-- Recent Networks Table -->
<article>
  <header>Recent Networks</header>
  <div class="overflow-auto">
    <table class="striped">
      <thead>
        <tr>
          <th scope="col">Name</th>
          <th scope="col">ASN</th>
          <th scope="col">Type</th>
          <th scope="col">Policy</th>
          <th scope="col">Website</th>
        </tr>
      </thead>
      <tbody>
        {% for network in networks %}
        <tr>
          <td><strong>{{ network.name }}</strong></td>
          <td>{{ network.asn }}</td>
          <td><span class="badge">{{ network.info_type or 'Unknown' }}</span></td>
          <td><span class="badge badge-secondary">{{ network.policy_general or 'Unknown' }}</span></td>
          <td>
            {% if network.website %}
            <a href="{{ network.website }}" target="_blank" role="button" class="outline sm">Visit</a>
            {% else %}
            <span class="secondary">-</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</article>
{% endblock %}

{% block scripts %}
<script>
  // Modern Theme Colors for Charts
  const colors = {
    primary: '#3b82f6',
    secondary: '#10b981',
    accent: '#f59e0b',
    background: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'],
    text: '#64748b'
  };

  /* Network Types Chart */
  let networkTypesChart = null;
  
  async function loadNetworkTypesChart() {
    const loading = document.getElementById("networkTypesLoading");
    const canvas = document.getElementById("networkTypesChart");
    const error = document.getElementById("networkTypesError");

    loading.style.display = "block";
    canvas.style.display = "none";
    error.style.display = "none";

    try {
      const response = await fetch("/api/network-types");
      if (!response.ok) throw new Error("API Error");
      const data = await response.json();

      loading.style.display = "none";
      canvas.style.display = "block";
      
      const ctx = canvas.getContext("2d");
      if (networkTypesChart) networkTypesChart.destroy();

      networkTypesChart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: data.labels,
          datasets: [{
            data: data.data,
            backgroundColor: colors.background,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    } catch (err) {
      loading.style.display = "none";
      error.style.display = "block";
      console.error(err);
    }
  }

  /* Prefixes Chart */
  let prefixesChart = null;

  async function loadPrefixesChart() {
    const loading = document.getElementById("prefixesLoading");
    const canvas = document.getElementById("prefixesChart");
    const error = document.getElementById("prefixesError");

    loading.style.display = "block";
    canvas.style.display = "none";
    error.style.display = "none";

    try {
      const response = await fetch("/api/prefixes-distribution");
      if (!response.ok) throw new Error("API Error");
      const data = await response.json();

      loading.style.display = "none";
      canvas.style.display = "block";

      const ctx = canvas.getContext("2d");
       if (prefixesChart) prefixesChart.destroy();

      prefixesChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.networks,
          datasets: [
            {
              label: 'IPv4',
              data: data.ipv4,
              backgroundColor: colors.primary
            },
            {
              label: 'IPv6',
              data: data.secondary,
              backgroundColor: colors.secondary
            }
          ]
        },
        options: {
           responsive: true,
           maintainAspectRatio: false,
           interaction: { mode: 'index', intersect: false },
           scales: {
             x: { stacked: false },
             y: { stacked: false }
           }
        }
      });
    } catch (err) {
       loading.style.display = "none";
       error.style.display = "block";
       console.error(err);
    }
  }

  // Init
  document.addEventListener('DOMContentLoaded', () => {
    loadNetworkTypesChart();
    loadPrefixesChart();
  });
</script>
{% endblock %}
