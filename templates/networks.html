{% extends "base.html" %}

{% block title %}Networks - NetViz{% endblock %}

{% block content %}
<hgroup>
  <h1>Networks</h1>
  <p>Browse and filter network data</p>
</hgroup>

<!-- Filter Bar -->
<section>
  <form action="/networks" method="get" id="searchForm">
    <div class="grid">
        <div>
            <input type="search" name="q" id="searchInput" placeholder="Search networks (name, ASN)..." aria-label="Search" value="{{ q|default(value='') }}">
        </div>
        <div class="grid">
            <select name="type" id="typeFilter" aria-label="Filter by Type" onchange="this.form.submit()">
                <option value="" {% if not type_filter %}selected{% endif %}>All Types</option>
                <option value="ISP" {% if type_filter == 'ISP' %}selected{% endif %}>ISP</option>
                <option value="Content" {% if type_filter == 'Content' %}selected{% endif %}>Content</option>
                <option value="Enterprise" {% if type_filter == 'Enterprise' %}selected{% endif %}>Enterprise</option>
            </select>
            <select name="policy" id="policyFilter" aria-label="Filter by Policy" onchange="this.form.submit()">
                <option value="" {% if not policy_filter %}selected{% endif %}>All Policies</option>
                <option value="Open" {% if policy_filter == 'Open' %}selected{% endif %}>Open</option>
                <option value="Restrictive" {% if policy_filter == 'Restrictive' %}selected{% endif %}>Restrictive</option>
            </select>
            <select name="status" id="statusFilter" aria-label="Filter by Status" onchange="this.form.submit()">
                <option value="" {% if not status_filter %}selected{% endif %}>All Status</option>
                <option value="ok" {% if status_filter == 'ok' %}selected{% endif %}>OK</option>
                <option value="error" {% if status_filter == 'error' %}selected{% endif %}>Error</option>
            </select>
        </div>
    </div>
    <!-- Hidden per_page input to persist it when filtering -->
    <input type="hidden" name="per_page" value="{{ per_page }}">
  </form>
</section>

<!-- Table -->
<section>
  <div class="overflow-auto">
    <table class="striped">
      <thead>
        <tr>
          <th scope="col">Network</th>
          <th scope="col">ASN</th>
          <th scope="col">Type</th>
          <th scope="col">IPv4 w/ IPv6</th>
          <th scope="col">Policy</th>
          <th scope="col">Status</th>
        </tr>
      </thead>
      <tbody>
        {% for network in networks %}
        <tr>
          <td>
            <strong>{{ network.name }}</strong>
            {% if network.aka %}<br><small>{{ network.aka }}</small>{% endif %}
          </td>
          <td><mark>AS{{ network.asn }}</mark></td>
          <td><span class="badge">{{ network.info_type or 'Unknown' }}</span></td>
          <td>
             {{ network.info_prefixes4 or '0' }} / {{ network.info_prefixes6 or '0' }}
          </td>
          <td>
            {% if network.policy_general == 'Open' %}
            <span class="badge" style="background-color: var(--pico-ins-color);">Open</span>
            {% elif network.policy_general == 'Restrictive' %}
            <span class="badge secondary">Restrictive</span>
            {% else %}
            <span class="badge secondary">{{ network.policy_general or 'Unknown' }}</span>
            {% endif %}
          </td>
          <td>
             {% if network.status == 'ok' %}
             <span class="badge" style="background-color: var(--pico-ins-color);">OK</span>
             {% else %}
             <span class="badge" style="background-color: var(--pico-del-color);">{{ network.status }}</span>
             {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<!-- Pagination -->
<nav>
  <ul>
       <!-- Retain search params in links -->
       {% set q_val = q | default(value="") %}
       {% set type_val = type_filter | default(value="") %}
       {% set policy_val = policy_filter | default(value="") %}
       {% set status_val = status_filter | default(value="") %}
       {% set params = "&per_page=" ~ per_page ~ "&q=" ~ q_val ~ "&type=" ~ type_val ~ "&policy=" ~ policy_val ~ "&status=" ~ status_val %}
       {% if page > 1 %}
       <a href="/networks?page={{ page - 1 }}{{ params }}" role="button" class="outline">Previous</a>
       {% else %}
       <button disabled class="outline">Previous</button>
       {% endif %}
    </li>
  </ul>
  <ul>
    <li><small>Page {{ page }} of {% if total_pages > 0 %}{{ total_pages }}{% else %}1{% endif %}</small></li>
  </ul>
  <ul>
    <li>
       {% if page < total_pages %}
       <a href="/networks?page={{ page + 1 }}{{ params }}" role="button" class="outline">Next</a>
       {% else %}
       <button disabled class="outline">Next</button>
       {% endif %}
    </li>
  </ul>
</nav>

<footer class="container">
    <div class="grid">
        <small>Showing {{ networks|length }} of {{ total_networks }} networks</small>
        <div style="text-align: right;">
            <select id="perPageSelect" style="width: auto; display: inline-block;" onchange="updatePerPage(this.value)">
                <option value="25" {% if per_page == 25 %}selected{% endif %}>25 per page</option>
                <option value="50" {% if per_page == 50 %}selected{% endif %}>50 per page</option>
                <option value="100" {% if per_page == 100 %}selected{% endif %}>100 per page</option>
            </select>
        </div>
    </div>
</footer>

{% endblock %}

{% block scripts %}
<script>
    function updatePerPage(val) {
        const url = new URL(window.location.href);
        url.searchParams.set("per_page", val);
        url.searchParams.set("page", "1");
        window.location.href = url.toString();
    }

    document.addEventListener("DOMContentLoaded", function () {
        const searchInput = document.getElementById("searchInput");
        const perPageSelect = document.getElementById("perPageSelect");

        // Per page init
        const urlParams = new URLSearchParams(window.location.search);
        if(perPageSelect) perPageSelect.value = urlParams.get("per_page") || "25";
        
        // Submit form on search input change
        searchInput?.addEventListener("input", function() {
            document.getElementById("searchForm").submit();
        });
    });
</script>
{% endblock %}
