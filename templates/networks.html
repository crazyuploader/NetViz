{% extends "base.html" %}

{% block title %}Networks - NetViz{% endblock %}

{% block content %}
<hgroup>
  <h1>Networks</h1>
  <p>Browse and filter network data</p>
</hgroup>

<!-- Filter Bar -->
<section>
  <div class="grid">
    <div>
        <input type="search" id="searchInput" placeholder="Filter current page..." aria-label="Search">
    </div>
    <div class="grid">
        <select id="typeFilter" aria-label="Filter by Type">
            <option value="">All Types</option>
            <option value="ISP">ISP</option>
            <option value="Content">Content</option>
            <option value="Enterprise">Enterprise</option>
        </select>
        <select id="policyFilter" aria-label="Filter by Policy">
            <option value="">All Policies</option>
            <option value="Open">Open</option>
            <option value="Restrictive">Restrictive</option>
        </select>
        <select id="statusFilter" aria-label="Filter by Status">
            <option value="">All Status</option>
            <option value="ok">OK</option>
            <option value="error">Error</option>
        </select>
    </div>
  </div>
</section>

<!-- Table -->
<section>
  <div class="overflow-auto">
    <table class="striped">
      <thead>
        <tr>
          <th scope="col">Network</th>
          <th scope="col">ASN</th>
          <th scope="col">Type</th>
          <th scope="col">IPv4 w/ IPv6</th>
          <th scope="col">Policy</th>
          <th scope="col">Status</th>
        </tr>
      </thead>
      <tbody>
        {% for network in networks %}
        <tr>
          <td>
            <strong>{{ network.name }}</strong>
            {% if network.aka %}<br><small>{{ network.aka }}</small>{% endif %}
          </td>
          <td><mark>AS{{ network.asn }}</mark></td>
          <td><span class="badge">{{ network.info_type or 'Unknown' }}</span></td>
          <td>
             {{ network.info_prefixes4 or '0' }} / {{ network.info_prefixes6 or '0' }}
          </td>
          <td>
            {% if network.policy_general == 'Open' %}
            <span class="badge" style="background-color: var(--pico-ins-color);">Open</span>
            {% elif network.policy_general == 'Restrictive' %}
            <span class="badge secondary">Restrictive</span>
            {% else %}
            <span class="badge secondary">{{ network.policy_general or 'Unknown' }}</span>
            {% endif %}
          </td>
          <td>
             {% if network.status == 'ok' %}
             <span class="badge" style="background-color: var(--pico-ins-color);">OK</span>
             {% else %}
             <span class="badge" style="background-color: var(--pico-del-color);">{{ network.status }}</span>
             {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<!-- Pagination -->
<nav>
  <ul>
    <li>
       {% if page > 1 %}
       <a href="/networks?page={{ page - 1 }}&per_page={{ per_page }}">Previous</a>
       {% else %}
       <a href="#" role="button" class="secondary outline" aria-disabled="true">Previous</a>
       {% endif %}
    </li>
  </ul>
  <ul>
    <li>Page {{ page }} of {% if total_pages > 0 %}{{ total_pages }}{% else %}1{% endif %}</li>
  </ul>
  <ul>
    <li>
       {% if page < total_pages %}
       <a href="/networks?page={{ page + 1 }}&per_page={{ per_page }}">Next</a>
       {% else %}
       <a href="#" role="button" class="secondary outline" aria-disabled="true">Next</a>
       {% endif %}
    </li>
  </ul>
</nav>

<footer class="container">
    <div class="grid">
        <small>Showing {{ networks|length }} of {{ total_networks }} networks</small>
        <div style="text-align: right;">
            <select id="perPageSelect" style="width: auto; display: inline-block;">
                <option value="25">25 per page</option>
                <option value="50">50 per page</option>
                <option value="100">100 per page</option>
            </select>
        </div>
    </div>
</footer>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const searchInput = document.getElementById("searchInput");
        const typeFilter = document.getElementById("typeFilter");
        const policyFilter = document.getElementById("policyFilter");
        const statusFilter = document.getElementById("statusFilter");
        const perPageSelect = document.getElementById("perPageSelect");

        // Per page init
        const urlParams = new URLSearchParams(window.location.search);
        if(perPageSelect) perPageSelect.value = urlParams.get("per_page") || "25";
        
        perPageSelect?.addEventListener("change", function() {
             const url = new URL(window.location.href);
             url.searchParams.set("per_page", this.value);
             url.searchParams.set("page", "1");
             window.location.href = url.toString();
        });

        // Client-side filtering
        function filterTable() {
            const term = searchInput.value.toLowerCase();
            const type = typeFilter.value.toLowerCase();
            const policy = policyFilter.value.toLowerCase();
            const status = statusFilter.value.toLowerCase();

            const rows = document.querySelectorAll("tbody tr");
            
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                const rowType = row.cells[2].textContent.toLowerCase();
                const rowPolicy = row.cells[4].textContent.toLowerCase();
                const rowStatus = row.cells[5].textContent.toLowerCase();

                const matchesTerm = !term || text.includes(term);
                const matchesType = !type || rowType.includes(type);
                const matchesPolicy = !policy || rowPolicy.includes(policy);
                const matchesStatus = !status || rowStatus.includes(status);

                row.style.display = (matchesTerm && matchesType && matchesPolicy && matchesStatus) ? "" : "none";
            });
        }

        [searchInput, typeFilter, policyFilter, statusFilter].forEach(el => {
            el?.addEventListener("input", filterTable);
        });
    });
</script>
{% endblock %}
